import socket
from multiprocessing.pool import ThreadPool
import os
import csv

def Main():

    while(True):    
        SERVER_HOST = ""
        SERVER_PORT = 5005
        BUFFER_SIZE = 1024
        SEPARATOR = "<SEPARATOR>"

        s = socket.socket()

        s.bind((SERVER_HOST,SERVER_PORT))
        s.listen(1)
        print(f"[*] Listening as {SERVER_HOST}:{SERVER_PORT}")

        client_socket, address = s.accept()

        print(f"[+] {address} is connected.")

        received = client_socket.recv(BUFFER_SIZE).decode()
        filename, filesize = received.split(SEPARATOR)
        filename = os.path.basename(filename)

        number_of_workers = os.cpu_count()
        print(f"\nRunning using {number_of_workers} workers.\n")
        with open(filename, "wb") as f: 
            with ThreadPool(number_of_workers) as pool:
                while True:
                    bytes_read = client_socket.recv(BUFFER_SIZE)
                    f.write(bytes_read)
                    if not bytes_read:
                        break

    s.close()


if __name__ == '__main__':
	Main()
